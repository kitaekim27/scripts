#!/bin/bash
set -o errexit -o nounset -o noglob -o pipefail

this_script=$(basename "$0")

info() {
    echo "$this_script:" "$@"
}

error() {
    echo "$this_script:" "$@" >&2
}

if [ "$EUID" != 0 ]
then
    error "this script requires root privilege!"
    exit 1
fi

readonly initramfs_path="/usr/src/initramfs"

rcopy() {
    local src="$1"
    local dst="$2"

    cp --verbose --preserve --no-dereference "$src" "$dst"

    deps=$(env --unset="LD_PRELOAD" ldd "$src" \
        | sed -e "
            /\//!d;
            /=>/ {s/.*=>[[:blank:]]*\([^[:blank:]]*\).*/\1/};
            s/[[:blank:]]*\([^[:blank:]]*\) (.*)/\1/
        ")

    for dep in $deps
    do
        mkdir --parents "${initramfs_path}${dep%/*}"
        cp --verbose --preserve --no-dereference "$dep" "${initramfs_path}${dep}"
        # if it's a symbolic link, copy the pointing file too
        if [ -L "$dep" ]
        then
            local target
            target=$(readlink -f "$dep")
            mkdir --parents "${initramfs_path}${target%/*}"
            cp --verbose --preserve --no-dereference "$target" "${initramfs_path}${target}"
        fi
    done
}

info "install the busybox inside the initramfs"
rcopy $(which busybox) "${initramfs_path}$(which busybox)"
chroot "$initramfs_path" busybox --install

info "install the tpm2-tools inside the initramfs"
rcopy $(which tpm2) "${initramfs_path}$(which tpm2)"

info "install the cryptsetup inside the initramfs"
rcopy $(which cryptsetup) "${initramfs_path}$(which cryptsetup)"

info "generate and install the initramfs to /boot"
find "$initramfs_path" -print0 \
    | cpio --null --create --verbose --format="newc" \
    | lz4 --to-stdout > /boot/initramfs.cpio.lz4
