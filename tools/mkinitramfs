#!/bin/bash
# Build and install an initramfs.
#
# Note that this script expects that `/usr/src/initramfs` directory contains all
# the necessary files.
#
# This script does not copy any firmware and modules into the initramfs.
# If you're willing to copy them, copy files in /lib/firmware and /lib/modules.

set -o errexit -o nounset -o noglob -o pipefail

this_script=$(basename "$0")

info() {
    echo "$this_script:" "$@"
}

error() {
    info "$@" >&2
}

if [ "$EUID" != 0 ]
then
    error "This script requires root privilege!"
    exit 1
fi

initramfs_source="/usr/src/initramfs"
initramfs_builddir=$(mktemp --directory --tmpdir "$this_script.XXXXXXXXXX")
linux_version=$(lslinux | fzf --header="Select a target linux kernel version.")

# Note that directories created here are not a complete set; You might need to
# add some directories here in the future.
info "Set the filesystem hierarchy layout."
for path in /proc /sys /run /tmp /mnt/root /etc /bin /sbin /usr/bin /usr/local/bin
do
    mkdir --parents "$initramfs_builddir$path"
done
ln --symbolic /proc/self/mounts "$initramfs_builddir/etc/mtab"

info "Copy files in the source directory into the build directory."
find "$initramfs_source" -mindepth 1 -maxdepth 1 \
    -exec cp --recursive --preserve --no-dereference {} "$initramfs_builddir" \;

info "Copy my scripts into the initramfs build directory."
cp "$(locatebin mkpassphrase)" "$initramfs_builddir/usr/local/bin"

info "Set up a basic shell environment in the initramfs build directory."
rcopy "$(locatebin "bash")" "$initramfs_builddir"
ln --symbolic "$(locatebin bash)" "$initramfs_builddir/bin/sh"
for target in "sed" "stty" "echo" "find" "sleep" "[" "printf" "mount" "umount" \
    "switch_root" "findfs" "grep" "ls" "less"
do
    rcopy "$(locatebin "$target")" "$initramfs_builddir"
done

info "Install the xxd utility into the initramfs build directory."
rcopy "$(locatebin xxd)" "$initramfs_builddir"

info "Install the tpm2-tools into the initramfs build directory."
rcopy "$(locatebin tpm2)" "$initramfs_builddir"

info "Install the cryptsetup into the initramfs build directory."
rcopy "$(locatebin cryptsetup)" "$initramfs_builddir"

info "Build and install the initramfs into /boot."
( cd "$initramfs_builddir" && find . -mindepth 1 -print0 \
    | cpio --null --create --format="newc" \
    | gzip > "/boot/initrd.img-$linux_version" )
