#!/bin/bash
# Build and install an initramfs.
#
# Note that this script expects that `/usr/src/initramfs` directory contains all
# the necessary files.

set -o errexit -o nounset -o noglob -o pipefail

this_script=$(basename "$0")

info() {
    echo "$this_script:" "$@"
}

error() {
    info "$@" >&2
}

if [ "$EUID" != 0 ]
then
    error "This script requires root privilege!"
    exit 1
fi

readonly INITRAMFS_PATH="/usr/src/initramfs"

tmpdir=$(mktemp --directory)

info "Copy files in $INITRAMFS_PATH into $tmpdir."
find "$INITRAMFS_PATH" -maxdepth 1 \
    -exec cp --preserve --recursive --no-dereference {} "$tmpdir" \;

info "Install the busybox into the initramfs."
rcopy "$(which busybox)" "$tmpdir"
chroot "$tmpdir" /bin/busybox --install

info "Install the tpm2-tools into the initramfs."
rcopy "$(which tpm2)" "$tmpdir"

info "Install the cryptsetup into the initramfs."
rcopy "$(which cryptsetup)" "$tmpdir"

info "Build and install the initramfs into /boot."
find "$tmpdir" -print0 \
    | cpio --null --create --verbose --format="newc" \
    | lz4 --to-stdout > /boot/initramfs.cpio.lz4
