#!/bin/bash
# Build and install an initramfs.
#
# Note that this script expects that `/usr/src/initramfs` directory contains all
# the necessary files.

set -o errexit -o nounset -o noglob -o pipefail

THIS_SCRIPT=$(basename "$0")
readonly THIS_SCRIPT

info() {
    echo "$THIS_SCRIPT:" "$@"
}

error() {
    info "$@" >&2
}

if [ "$EUID" != 0 ]
then
    error "This script requires root privilege!"
    exit 1
fi

readonly INITRAMFS_SOURCE="/usr/src/initramfs"

INITRAMFS_ROOT=$(mktemp --directory)
readonly INITRAMFS_ROOT

info "INITRAMFS_SOURCE=$INITRAMFS_SOURCE"
info "INITRAMFS_ROOT=$INITRAMFS_ROOT"

info "Copy files in the initramfs source into the initramfs root."
find "$INITRAMFS_SOURCE" -mindepth 1 -maxdepth 1 \
    -exec cp --recursive --preserve --no-dereference {} "$INITRAMFS_ROOT" \;

info "Copy my scripts into the initramfs root."
cp $(which mkpassphrase) "$INITRAMFS_ROOT/usr/local/bin"

info "Install the busybox into the initramfs root."
rcopy "$(which busybox)" "$INITRAMFS_ROOT"
chroot "$INITRAMFS_ROOT" /bin/busybox --install

info "Install the tpm2-tools into the initramfs root."
rcopy "$(which tpm2)" "$INITRAMFS_ROOT"

info "Install the cryptsetup into the initramfs root."
rcopy "$(which cryptsetup)" "$INITRAMFS_ROOT"

info "Build and install the initramfs into /boot."
( cd "$INITRAMFS_ROOT" && find -mindepth 1 -print0 \
    | cpio --null --create --format="newc" \
    | lz4 --to-stdout > /boot/initramfs.cpio.lz4 )
