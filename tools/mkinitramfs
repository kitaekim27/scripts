#!/bin/bash
# Build and install an initramfs.
#
# Note that this script expects that `/usr/src/initramfs` directory contains all
# the necessary files.
#
# This script does not copy any firmware and modules into the initramfs.
# If you're willing to copy them, copy files in /lib/firmware and /lib/modules.

set -o errexit -o nounset -o noglob -o pipefail

info() {
    echo "$(basename "$0"):" "$@"
}

error() {
    info "$@" >&2
}

if [ "$EUID" != 0 ]
then
    error "This script requires root privilege!"
    exit 1
fi

initramfs_source="/usr/src/initramfs"
initramfs_builddir=$(mktemp --directory)
linux_version=$(lslinux | fzf --header="Select the target linux kernel version.")

# Note that directories created here are not a complete set; You might need to
# add some directories here in the future.
info "Set the filesystem hierarchy layout."
mkdir --parents \
    "$initramfs_builddir/proc" \
    "$initramfs_builddir/sys" \
    "$initramfs_builddir/run" \
    "$initramfs_builddir/tmp" \
    "$initramfs_builddir/mnt/root" \
    "$initramfs_builddir/sbin" \
    "$initramfs_builddir/etc" \
    "$initramfs_builddir/lib" \
    "$initramfs_builddir/lib32" \
    "$initramfs_builddir/lib64" \
    "$initramfs_builddir/usr/local/bin"
ln --symbolic /proc/self/mounts "$initramfs_builddir/etc/mtab"

info "Copy files in the source directory into the build directory."
find "$initramfs_source" -mindepth 1 -maxdepth 1 \
    -exec cp --recursive --preserve --no-dereference {} "$initramfs_builddir" \;

info "Copy my scripts into the initramfs build directory."
cp "$(which mkpassphrase)" "$initramfs_builddir/usr/local/bin"

info "Install the busybox into the initramfs build directory."
rcopy "$(which busybox)" "$initramfs_builddir"
for target in $(busybox --list)
do
    path=$(whereis "$target" | awk '{print $2}')
    [ -n "$path" ] && ln --symbolic "$(which busybox)" "$initramfs_builddir$path"
done

info "Install the xxd utility into the initramfs build directory."
rcopy "$(which xxd)" "$initramfs_builddir"

info "Install the tpm2-tools into the initramfs build directory."
rcopy "$(which tpm2)" "$initramfs_builddir"

info "Install the cryptsetup into the initramfs build directory."
rcopy "$(which cryptsetup)" "$initramfs_builddir"

info "Build and install the initramfs into /boot."
( cd "$initramfs_builddir" && find . -mindepth 1 -print0 \
    | cpio --null --create --format="newc" \
    | lz4 --to-stdout > "/boot/initrd.img-$linux_version" )
